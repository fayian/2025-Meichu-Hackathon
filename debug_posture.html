<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å§¿å‹¢æª¢æ¸¬èª¿è©¦å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background-color: #f8f9fa; }
        button { padding: 8px 15px; margin: 5px; }
        .status { padding: 5px 10px; margin: 5px 0; border-radius: 3px; }
        .good { background-color: #d4edda; color: #155724; }
        .bad { background-color: #f8d7da; color: #721c24; }
        .unknown { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>å§¿å‹¢æª¢æ¸¬èª¿è©¦å·¥å…·</h1>
    
    <div class="debug-section">
        <h2>API æ¸¬è©¦</h2>
        <button onclick="testAPI()">æ¸¬è©¦ API é€£æ¥</button>
        <button onclick="startPostureTest()">å•Ÿå‹•å§¿å‹¢æª¢æ¸¬</button>
        <button onclick="stopPostureTest()">åœæ­¢å§¿å‹¢æª¢æ¸¬</button>
        <button onclick="checkPostureOnce()">æª¢æŸ¥ä¸€æ¬¡å§¿å‹¢</button>
    </div>

    <div class="debug-section">
        <h2>å§¿å‹¢ç‹€æ…‹</h2>
        <div>ç•¶å‰å§¿å‹¢: <span id="currentPosture" class="status unknown">æœªçŸ¥</span></div>
        <div>ä¸è‰¯å§¿å‹¢è¨ˆæ•¸: <span id="badCount">0</span></div>
        <div>æª¢æ¸¬ç‹€æ…‹: <span id="detectionStatus">æœªå•Ÿå‹•</span></div>
    </div>

    <div class="debug-section">
        <h2>èª¿è©¦æ—¥èªŒ</h2>
        <div id="debugLog" class="log"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let badPostureCount = 0;
        let postureTimer = null;

        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        function updatePostureDisplay(posture) {
            const element = document.getElementById('currentPosture');
            element.textContent = posture;
            element.className = `status ${posture}`;
        }

        async function testAPI() {
            try {
                const response = await fetch(`${API_URL}/`);
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… API é€£æ¥æˆåŠŸ: ${data.message}`);
                } else {
                    log(`âŒ API å›æ‡‰ç•°å¸¸: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ API é€£æ¥å¤±æ•—: ${error.message}`);
            }
        }

        async function startPostureTest() {
            try {
                const response = await fetch(`${API_URL}/start_posture_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… å§¿å‹¢æª¢æ¸¬å•Ÿå‹•: ${data.message}`);
                    document.getElementById('detectionStatus').textContent = 'æª¢æ¸¬ä¸­';
                    
                    // é–‹å§‹æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡
                    if (postureTimer) clearInterval(postureTimer);
                    postureTimer = setInterval(checkPosture, 5000);
                    log('ğŸ”„ é–‹å§‹æ¯5ç§’è‡ªå‹•æª¢æŸ¥å§¿å‹¢');
                } else {
                    log(`âŒ å•Ÿå‹•å¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ å•Ÿå‹•éŒ¯èª¤: ${error.message}`);
            }
        }

        async function stopPostureTest() {
            try {
                if (postureTimer) {
                    clearInterval(postureTimer);
                    postureTimer = null;
                }

                const response = await fetch(`${API_URL}/stop_posture_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`â¹ï¸ å§¿å‹¢æª¢æ¸¬åœæ­¢: ${data.message}`);
                    document.getElementById('detectionStatus').textContent = 'æœªå•Ÿå‹•';
                    badPostureCount = 0;
                    document.getElementById('badCount').textContent = badPostureCount;
                } else {
                    log(`âŒ åœæ­¢å¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ åœæ­¢éŒ¯èª¤: ${error.message}`);
            }
        }

        async function checkPostureOnce() {
            try {
                const response = await fetch(`${API_URL}/get_posture`);
                if (response.ok) {
                    const data = await response.json();
                    const posture = data.posture;
                    
                    log(`ğŸ“Š å§¿å‹¢æª¢æ¸¬çµæœ: "${posture}"`);
                    updatePostureDisplay(posture);
                    
                    return posture;
                } else {
                    log(`âŒ æª¢æ¸¬å¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                log(`âŒ æª¢æ¸¬éŒ¯èª¤: ${error.message}`);
            }
        }

        async function checkPosture() {
            const posture = await checkPostureOnce();
            if (!posture) return;

            // æª¢æŸ¥æ˜¯å¦ç‚ºä¸è‰¯å§¿å‹¢
            const isBadPosture = (
                posture === 'bad' || 
                posture === 'poor' || 
                posture === 'incorrect' ||
                posture === 'Poor Posture' ||
                posture === 'Bad Posture' ||
                posture.toLowerCase().includes('poor') ||
                posture.toLowerCase().includes('bad')
            );
            
            if (isBadPosture) {
                badPostureCount++;
                document.getElementById('badCount').textContent = badPostureCount;
                log(`âš ï¸ ä¸è‰¯å§¿å‹¢æª¢æ¸¬ (é€£çºŒç¬¬${badPostureCount}æ¬¡): "${posture}"`);

                if (badPostureCount >= 2) {
                    log('ğŸš¨ è§¸ç™¼è­¦å‘Šï¼é€£çºŒ2æ¬¡ä¸è‰¯å§¿å‹¢');
                    alert('ğŸš¨ å§¿å‹¢è­¦å‘Šï¼\\n\\næ‚¨å·²ç¶“é€£çºŒä¿æŒä¸è‰¯åå§¿è¶…é10ç§’ï¼Œè«‹ç«‹å³èª¿æ•´æ‚¨çš„åå§¿ï¼');
                    badPostureCount = 0; // é‡ç½®è¨ˆæ•¸å™¨
                    document.getElementById('badCount').textContent = badPostureCount;
                }
            } else {
                if (badPostureCount > 0) {
                    log(`âœ… å§¿å‹¢æ¢å¾©æ­£å¸¸: "${posture}" (é‡ç½®è¨ˆæ•¸å™¨)`);
                }
                badPostureCount = 0;
                document.getElementById('badCount').textContent = badPostureCount;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦
        window.addEventListener('load', () => {
            log('ğŸš€ å§¿å‹¢æª¢æ¸¬èª¿è©¦å·¥å…·è¼‰å…¥å®Œæˆ');
            testAPI();
        });
    </script>
</body>
</html>