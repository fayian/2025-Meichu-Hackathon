<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>姿勢檢測調試工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background-color: #f8f9fa; }
        button { padding: 8px 15px; margin: 5px; }
        .status { padding: 5px 10px; margin: 5px 0; border-radius: 3px; }
        .good { background-color: #d4edda; color: #155724; }
        .bad { background-color: #f8d7da; color: #721c24; }
        .unknown { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>姿勢檢測調試工具</h1>
    
    <div class="debug-section">
        <h2>API 測試</h2>
        <button onclick="testAPI()">測試 API 連接</button>
        <button onclick="startPostureTest()">啟動姿勢檢測</button>
        <button onclick="stopPostureTest()">停止姿勢檢測</button>
        <button onclick="checkPostureOnce()">檢查一次姿勢</button>
    </div>

    <div class="debug-section">
        <h2>姿勢狀態</h2>
        <div>當前姿勢: <span id="currentPosture" class="status unknown">未知</span></div>
        <div>不良姿勢計數: <span id="badCount">0</span></div>
        <div>檢測狀態: <span id="detectionStatus">未啟動</span></div>
    </div>

    <div class="debug-section">
        <h2>調試日誌</h2>
        <div id="debugLog" class="log"></div>
        <button onclick="clearLog()">清除日誌</button>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let badPostureCount = 0;
        let postureTimer = null;

        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        function updatePostureDisplay(posture) {
            const element = document.getElementById('currentPosture');
            element.textContent = posture;
            element.className = `status ${posture}`;
        }

        async function testAPI() {
            try {
                const response = await fetch(`${API_URL}/`);
                if (response.ok) {
                    const data = await response.json();
                    log(`✅ API 連接成功: ${data.message}`);
                } else {
                    log(`❌ API 回應異常: ${response.status}`);
                }
            } catch (error) {
                log(`❌ API 連接失敗: ${error.message}`);
            }
        }

        async function startPostureTest() {
            try {
                const response = await fetch(`${API_URL}/start_posture_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`✅ 姿勢檢測啟動: ${data.message}`);
                    document.getElementById('detectionStatus').textContent = '檢測中';
                    
                    // 開始每5秒檢查一次
                    if (postureTimer) clearInterval(postureTimer);
                    postureTimer = setInterval(checkPosture, 5000);
                    log('🔄 開始每5秒自動檢查姿勢');
                } else {
                    log(`❌ 啟動失敗: ${response.status}`);
                }
            } catch (error) {
                log(`❌ 啟動錯誤: ${error.message}`);
            }
        }

        async function stopPostureTest() {
            try {
                if (postureTimer) {
                    clearInterval(postureTimer);
                    postureTimer = null;
                }

                const response = await fetch(`${API_URL}/stop_posture_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`⏹️ 姿勢檢測停止: ${data.message}`);
                    document.getElementById('detectionStatus').textContent = '未啟動';
                    badPostureCount = 0;
                    document.getElementById('badCount').textContent = badPostureCount;
                } else {
                    log(`❌ 停止失敗: ${response.status}`);
                }
            } catch (error) {
                log(`❌ 停止錯誤: ${error.message}`);
            }
        }

        async function checkPostureOnce() {
            try {
                const response = await fetch(`${API_URL}/get_posture`);
                if (response.ok) {
                    const data = await response.json();
                    const posture = data.posture;
                    
                    log(`📊 姿勢檢測結果: "${posture}"`);
                    updatePostureDisplay(posture);
                    
                    return posture;
                } else {
                    log(`❌ 檢測失敗: ${response.status}`);
                }
            } catch (error) {
                log(`❌ 檢測錯誤: ${error.message}`);
            }
        }

        async function checkPosture() {
            const posture = await checkPostureOnce();
            if (!posture) return;

            // 檢查是否為不良姿勢
            const isBadPosture = (
                posture === 'bad' || 
                posture === 'poor' || 
                posture === 'incorrect' ||
                posture === 'Poor Posture' ||
                posture === 'Bad Posture' ||
                posture.toLowerCase().includes('poor') ||
                posture.toLowerCase().includes('bad')
            );
            
            if (isBadPosture) {
                badPostureCount++;
                document.getElementById('badCount').textContent = badPostureCount;
                log(`⚠️ 不良姿勢檢測 (連續第${badPostureCount}次): "${posture}"`);

                if (badPostureCount >= 2) {
                    log('🚨 觸發警告！連續2次不良姿勢');
                    alert('🚨 姿勢警告！\\n\\n您已經連續保持不良坐姿超過10秒，請立即調整您的坐姿！');
                    badPostureCount = 0; // 重置計數器
                    document.getElementById('badCount').textContent = badPostureCount;
                }
            } else {
                if (badPostureCount > 0) {
                    log(`✅ 姿勢恢復正常: "${posture}" (重置計數器)`);
                }
                badPostureCount = 0;
                document.getElementById('badCount').textContent = badPostureCount;
            }
        }

        // 頁面載入時自動測試
        window.addEventListener('load', () => {
            log('🚀 姿勢檢測調試工具載入完成');
            testAPI();
        });
    </script>
</body>
</html>