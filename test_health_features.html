<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>健康功能測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .status { padding: 5px 10px; margin: 5px 0; border-radius: 3px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        button { padding: 8px 15px; margin: 5px; }
        .success { background-color: #28a745; color: white; }
        .danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>健康監控系統測試頁面</h1>
    
    <div class="test-section">
        <h2>API 連接狀態</h2>
        <div id="apiStatus" class="status disconnected">檢查中...</div>
        <button onclick="testApiConnection()">測試 API 連接</button>
    </div>

    <div class="test-section">
        <h2>姿勢檢測測試</h2>
        <div id="postureStatus" class="status">未檢測</div>
        <button id="testPostureBtn" class="success" onclick="testPostureDetection()">測試姿勢檢測</button>
        <button id="stopPostureBtn" class="danger" onclick="stopPostureDetection()" disabled>停止檢測</button>
        <div>當前姿勢: <span id="currentPosture">未知</span></div>
        <div>不良姿勢計數: <span id="badCount">0</span></div>
    </div>

    <div class="test-section">
        <h2>喝水提醒測試</h2>
        <div id="waterStatus" class="status">未啟動</div>
        <label>提醒間隔 (分鐘): <input type="number" id="waterInterval" value="1" min="1" max="180"></label>
        <button id="testWaterBtn" class="success" onclick="testWaterReminder()">測試喝水提醒</button>
        <button id="stopWaterBtn" class="danger" onclick="stopWaterReminder()" disabled>停止提醒</button>
        <div>上次喝水時間: <span id="lastDrinkTime">未記錄</span></div>
    </div>

    <div class="test-section">
        <h2>測試日誌</h2>
        <div id="testLog" style="height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background-color: #f8f9fa;"></div>
        <button onclick="clearLog()">清除日誌</button>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let postureTimer = null;
        let waterTimer = null;
        let badPostureCount = 0;

        function log(message) {
            const logDiv = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        async function testApiConnection() {
            try {
                const response = await fetch(`${API_URL}/`);
                if (response.ok) {
                    document.getElementById('apiStatus').textContent = 'API 已連線';
                    document.getElementById('apiStatus').className = 'status connected';
                    log('✅ API 連接成功');
                } else {
                    throw new Error('API 回應異常');
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'API 未連線';
                document.getElementById('apiStatus').className = 'status disconnected';
                log('❌ API 連接失敗: ' + error.message);
            }
        }

        async function testPostureDetection() {
            try {
                // 啟動後端檢測
                const response = await fetch(`${API_URL}/start_posture_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    document.getElementById('postureStatus').textContent = '檢測中...';
                    document.getElementById('testPostureBtn').disabled = true;
                    document.getElementById('stopPostureBtn').disabled = false;
                    
                    // 每5秒檢查一次姿勢
                    postureTimer = setInterval(checkPosture, 5000);
                    log('✅ 姿勢檢測已啟動，每5秒檢查一次');
                } else {
                    throw new Error('啟動失敗');
                }
            } catch (error) {
                log('❌ 姿勢檢測啟動失敗: ' + error.message);
            }
        }

        async function checkPosture() {
            try {
                const response = await fetch(`${API_URL}/get_posture`);
                if (response.ok) {
                    const data = await response.json();
                    const posture = data.posture;
                    document.getElementById('currentPosture').textContent = posture;

                    // 檢查是否為不良姿勢
                    const isBadPosture = (
                        posture === 'bad' || 
                        posture === 'poor' || 
                        posture === 'Poor Posture' ||
                        posture === 'Bad Posture' ||
                        posture.toLowerCase().includes('poor') ||
                        posture.toLowerCase().includes('bad')
                    );

                    if (isBadPosture) {
                        badPostureCount++;
                        document.getElementById('badCount').textContent = badPostureCount;
                        log(`⚠️ 檢測到不良姿勢 (連續第${badPostureCount}次): "${posture}"`);

                        if (badPostureCount >= 2) {
                            alert('🚨 姿勢警告！\\n\\n您已經連續保持不良坐姿超過10秒，請立即調整您的坐姿！');
                            log('🚨 發出姿勢警告 (連續2次不良姿勢)');
                            badPostureCount = 0; // 重置計數器
                        }
                    } else {
                        badPostureCount = 0;
                        document.getElementById('badCount').textContent = badPostureCount;
                        log(`✅ 姿勢狀態: "${posture}"`);
                    }
                }
            } catch (error) {
                log('❌ 姿勢檢查失敗: ' + error.message);
            }
        }

        async function stopPostureDetection() {
            if (postureTimer) {
                clearInterval(postureTimer);
                postureTimer = null;
            }

            try {
                const response = await fetch(`${API_URL}/stop_posture_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    document.getElementById('postureStatus').textContent = '未檢測';
                    document.getElementById('testPostureBtn').disabled = false;
                    document.getElementById('stopPostureBtn').disabled = true;
                    badPostureCount = 0;
                    document.getElementById('badCount').textContent = badPostureCount;
                    log('⏹️ 姿勢檢測已停止');
                }
            } catch (error) {
                log('❌ 停止姿勢檢測失敗: ' + error.message);
            }
        }

        async function testWaterReminder() {
            try {
                // 啟動後端檢測
                const response = await fetch(`${API_URL}/start_drinking_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const interval = parseInt(document.getElementById('waterInterval').value);
                    document.getElementById('waterStatus').textContent = `提醒中 (${interval}分鐘間隔)`;
                    document.getElementById('testWaterBtn').disabled = true;
                    document.getElementById('stopWaterBtn').disabled = false;
                    
                    // 每分鐘檢查一次喝水時間
                    waterTimer = setInterval(() => checkWaterTime(interval), 60000);
                    log(`✅ 喝水提醒已啟動，間隔${interval}分鐘`);
                    
                    // 立即檢查一次
                    checkWaterTime(interval);
                } else {
                    throw new Error('啟動失敗');
                }
            } catch (error) {
                log('❌ 喝水提醒啟動失敗: ' + error.message);
            }
        }

        async function checkWaterTime(intervalMinutes) {
            try {
                const response = await fetch(`${API_URL}/get_last_drink_time`);
                if (response.ok) {
                    const data = await response.json();
                    const drinkTime = new Date(data.year, data.month - 1, data.day, data.hour, data.minute, data.second);
                    const now = new Date();
                    const timeDiff = now - drinkTime;
                    const minutesAgo = Math.floor(timeDiff / (1000 * 60));
                    
                    const timeStr = drinkTime.toLocaleString('zh-TW');
                    document.getElementById('lastDrinkTime').textContent = timeStr;
                    
                    log(`💧 上次喝水: ${minutesAgo}分鐘前`);
                    
                    if (minutesAgo >= intervalMinutes) {
                        const message = `您已經 ${minutesAgo} 分鐘沒有喝水了！記得補充水分哦`;
                        alert('💧 喝水提醒\\n\\n' + message);
                        log('🔔 發送喝水提醒通知');
                    }
                }
            } catch (error) {
                log('❌ 喝水時間檢查失敗: ' + error.message);
            }
        }

        async function stopWaterReminder() {
            if (waterTimer) {
                clearInterval(waterTimer);
                waterTimer = null;
            }

            try {
                const response = await fetch(`${API_URL}/stop_drinking_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    document.getElementById('waterStatus').textContent = '未啟動';
                    document.getElementById('testWaterBtn').disabled = false;
                    document.getElementById('stopWaterBtn').disabled = true;
                    log('⏹️ 喝水提醒已停止');
                }
            } catch (error) {
                log('❌ 停止喝水提醒失敗: ' + error.message);
            }
        }

        // 頁面載入時自動測試 API 連接
        window.addEventListener('load', () => {
            log('🚀 健康監控測試頁面已載入');
            testApiConnection();
        });
    </script>
</body>
</html>