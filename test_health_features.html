<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥åº·åŠŸèƒ½æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .status { padding: 5px 10px; margin: 5px 0; border-radius: 3px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        button { padding: 8px 15px; margin: 5px; }
        .success { background-color: #28a745; color: white; }
        .danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>å¥åº·ç›£æ§ç³»çµ±æ¸¬è©¦é é¢</h1>
    
    <div class="test-section">
        <h2>API é€£æ¥ç‹€æ…‹</h2>
        <div id="apiStatus" class="status disconnected">æª¢æŸ¥ä¸­...</div>
        <button onclick="testApiConnection()">æ¸¬è©¦ API é€£æ¥</button>
    </div>

    <div class="test-section">
        <h2>å§¿å‹¢æª¢æ¸¬æ¸¬è©¦</h2>
        <div id="postureStatus" class="status">æœªæª¢æ¸¬</div>
        <button id="testPostureBtn" class="success" onclick="testPostureDetection()">æ¸¬è©¦å§¿å‹¢æª¢æ¸¬</button>
        <button id="stopPostureBtn" class="danger" onclick="stopPostureDetection()" disabled>åœæ­¢æª¢æ¸¬</button>
        <div>ç•¶å‰å§¿å‹¢: <span id="currentPosture">æœªçŸ¥</span></div>
        <div>ä¸è‰¯å§¿å‹¢è¨ˆæ•¸: <span id="badCount">0</span></div>
    </div>

    <div class="test-section">
        <h2>å–æ°´æé†’æ¸¬è©¦</h2>
        <div id="waterStatus" class="status">æœªå•Ÿå‹•</div>
        <label>æé†’é–“éš” (åˆ†é˜): <input type="number" id="waterInterval" value="1" min="1" max="180"></label>
        <button id="testWaterBtn" class="success" onclick="testWaterReminder()">æ¸¬è©¦å–æ°´æé†’</button>
        <button id="stopWaterBtn" class="danger" onclick="stopWaterReminder()" disabled>åœæ­¢æé†’</button>
        <div>ä¸Šæ¬¡å–æ°´æ™‚é–“: <span id="lastDrinkTime">æœªè¨˜éŒ„</span></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦æ—¥èªŒ</h2>
        <div id="testLog" style="height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background-color: #f8f9fa;"></div>
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let postureTimer = null;
        let waterTimer = null;
        let badPostureCount = 0;

        function log(message) {
            const logDiv = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        async function testApiConnection() {
            try {
                const response = await fetch(`${API_URL}/`);
                if (response.ok) {
                    document.getElementById('apiStatus').textContent = 'API å·²é€£ç·š';
                    document.getElementById('apiStatus').className = 'status connected';
                    log('âœ… API é€£æ¥æˆåŠŸ');
                } else {
                    throw new Error('API å›æ‡‰ç•°å¸¸');
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = 'API æœªé€£ç·š';
                document.getElementById('apiStatus').className = 'status disconnected';
                log('âŒ API é€£æ¥å¤±æ•—: ' + error.message);
            }
        }

        async function testPostureDetection() {
            try {
                // å•Ÿå‹•å¾Œç«¯æª¢æ¸¬
                const response = await fetch(`${API_URL}/start_posture_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    document.getElementById('postureStatus').textContent = 'æª¢æ¸¬ä¸­...';
                    document.getElementById('testPostureBtn').disabled = true;
                    document.getElementById('stopPostureBtn').disabled = false;
                    
                    // æ¯5ç§’æª¢æŸ¥ä¸€æ¬¡å§¿å‹¢
                    postureTimer = setInterval(checkPosture, 5000);
                    log('âœ… å§¿å‹¢æª¢æ¸¬å·²å•Ÿå‹•ï¼Œæ¯5ç§’æª¢æŸ¥ä¸€æ¬¡');
                } else {
                    throw new Error('å•Ÿå‹•å¤±æ•—');
                }
            } catch (error) {
                log('âŒ å§¿å‹¢æª¢æ¸¬å•Ÿå‹•å¤±æ•—: ' + error.message);
            }
        }

        async function checkPosture() {
            try {
                const response = await fetch(`${API_URL}/get_posture`);
                if (response.ok) {
                    const data = await response.json();
                    const posture = data.posture;
                    document.getElementById('currentPosture').textContent = posture;

                    // æª¢æŸ¥æ˜¯å¦ç‚ºä¸è‰¯å§¿å‹¢
                    const isBadPosture = (
                        posture === 'bad' || 
                        posture === 'poor' || 
                        posture === 'Poor Posture' ||
                        posture === 'Bad Posture' ||
                        posture.toLowerCase().includes('poor') ||
                        posture.toLowerCase().includes('bad')
                    );

                    if (isBadPosture) {
                        badPostureCount++;
                        document.getElementById('badCount').textContent = badPostureCount;
                        log(`âš ï¸ æª¢æ¸¬åˆ°ä¸è‰¯å§¿å‹¢ (é€£çºŒç¬¬${badPostureCount}æ¬¡): "${posture}"`);

                        if (badPostureCount >= 2) {
                            alert('ğŸš¨ å§¿å‹¢è­¦å‘Šï¼\\n\\næ‚¨å·²ç¶“é€£çºŒä¿æŒä¸è‰¯åå§¿è¶…é10ç§’ï¼Œè«‹ç«‹å³èª¿æ•´æ‚¨çš„åå§¿ï¼');
                            log('ğŸš¨ ç™¼å‡ºå§¿å‹¢è­¦å‘Š (é€£çºŒ2æ¬¡ä¸è‰¯å§¿å‹¢)');
                            badPostureCount = 0; // é‡ç½®è¨ˆæ•¸å™¨
                        }
                    } else {
                        badPostureCount = 0;
                        document.getElementById('badCount').textContent = badPostureCount;
                        log(`âœ… å§¿å‹¢ç‹€æ…‹: "${posture}"`);
                    }
                }
            } catch (error) {
                log('âŒ å§¿å‹¢æª¢æŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function stopPostureDetection() {
            if (postureTimer) {
                clearInterval(postureTimer);
                postureTimer = null;
            }

            try {
                const response = await fetch(`${API_URL}/stop_posture_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    document.getElementById('postureStatus').textContent = 'æœªæª¢æ¸¬';
                    document.getElementById('testPostureBtn').disabled = false;
                    document.getElementById('stopPostureBtn').disabled = true;
                    badPostureCount = 0;
                    document.getElementById('badCount').textContent = badPostureCount;
                    log('â¹ï¸ å§¿å‹¢æª¢æ¸¬å·²åœæ­¢');
                }
            } catch (error) {
                log('âŒ åœæ­¢å§¿å‹¢æª¢æ¸¬å¤±æ•—: ' + error.message);
            }
        }

        async function testWaterReminder() {
            try {
                // å•Ÿå‹•å¾Œç«¯æª¢æ¸¬
                const response = await fetch(`${API_URL}/start_drinking_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const interval = parseInt(document.getElementById('waterInterval').value);
                    document.getElementById('waterStatus').textContent = `æé†’ä¸­ (${interval}åˆ†é˜é–“éš”)`;
                    document.getElementById('testWaterBtn').disabled = true;
                    document.getElementById('stopWaterBtn').disabled = false;
                    
                    // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡å–æ°´æ™‚é–“
                    waterTimer = setInterval(() => checkWaterTime(interval), 60000);
                    log(`âœ… å–æ°´æé†’å·²å•Ÿå‹•ï¼Œé–“éš”${interval}åˆ†é˜`);
                    
                    // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
                    checkWaterTime(interval);
                } else {
                    throw new Error('å•Ÿå‹•å¤±æ•—');
                }
            } catch (error) {
                log('âŒ å–æ°´æé†’å•Ÿå‹•å¤±æ•—: ' + error.message);
            }
        }

        async function checkWaterTime(intervalMinutes) {
            try {
                const response = await fetch(`${API_URL}/get_last_drink_time`);
                if (response.ok) {
                    const data = await response.json();
                    const drinkTime = new Date(data.year, data.month - 1, data.day, data.hour, data.minute, data.second);
                    const now = new Date();
                    const timeDiff = now - drinkTime;
                    const minutesAgo = Math.floor(timeDiff / (1000 * 60));
                    
                    const timeStr = drinkTime.toLocaleString('zh-TW');
                    document.getElementById('lastDrinkTime').textContent = timeStr;
                    
                    log(`ğŸ’§ ä¸Šæ¬¡å–æ°´: ${minutesAgo}åˆ†é˜å‰`);
                    
                    if (minutesAgo >= intervalMinutes) {
                        const message = `æ‚¨å·²ç¶“ ${minutesAgo} åˆ†é˜æ²’æœ‰å–æ°´äº†ï¼è¨˜å¾—è£œå……æ°´åˆ†å“¦`;
                        alert('ğŸ’§ å–æ°´æé†’\\n\\n' + message);
                        log('ğŸ”” ç™¼é€å–æ°´æé†’é€šçŸ¥');
                    }
                }
            } catch (error) {
                log('âŒ å–æ°´æ™‚é–“æª¢æŸ¥å¤±æ•—: ' + error.message);
            }
        }

        async function stopWaterReminder() {
            if (waterTimer) {
                clearInterval(waterTimer);
                waterTimer = null;
            }

            try {
                const response = await fetch(`${API_URL}/stop_drinking_test`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    document.getElementById('waterStatus').textContent = 'æœªå•Ÿå‹•';
                    document.getElementById('testWaterBtn').disabled = false;
                    document.getElementById('stopWaterBtn').disabled = true;
                    log('â¹ï¸ å–æ°´æé†’å·²åœæ­¢');
                }
            } catch (error) {
                log('âŒ åœæ­¢å–æ°´æé†’å¤±æ•—: ' + error.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦ API é€£æ¥
        window.addEventListener('load', () => {
            log('ğŸš€ å¥åº·ç›£æ§æ¸¬è©¦é é¢å·²è¼‰å…¥');
            testApiConnection();
        });
    </script>
</body>
</html>